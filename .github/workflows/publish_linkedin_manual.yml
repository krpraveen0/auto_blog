name: Publish LinkedIn - Manual (One-Click)

on:
  workflow_dispatch:
    inputs:
      skip_drafted:
        description: 'Skip drafted posts and generate new content first'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
      source:
        description: 'Content source to use (when generating new content)'
        required: false
        default: 'hackernews'
        type: choice
        options:
          - 'hackernews'
          - 'arxiv'
          - 'blogs'
          - 'github'
          - 'all'

jobs:
  publish_single_post:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Initialize project
        run: |
          python main.py init
      
      - name: Validate environment
        run: |
          set +e
          if [ -z "${{ secrets.LINKEDIN_ACCESS_TOKEN }}" ]; then
            echo "‚ùå Error: LINKEDIN_ACCESS_TOKEN not configured"
            echo "Add to: Settings > Secrets and variables > Actions > LINKEDIN_ACCESS_TOKEN"
            exit 1
          fi
          if [ -z "${{ secrets.LINKEDIN_USER_ID }}" ]; then
            echo "‚ùå Error: LINKEDIN_USER_ID not configured"
            echo "Add to: Settings > Secrets and variables > Actions > LINKEDIN_USER_ID"
            exit 1
          fi
          echo "‚úÖ LinkedIn credentials validated"

      - name: Validate Perplexity API key
        run: |
          set +e
          if [ -z "${{ secrets.PERPLEXITY_API_KEY }}" ]; then
            echo "‚ùå Error: PERPLEXITY_API_KEY not configured"
            echo "Add to: Settings > Secrets and variables > Actions > PERPLEXITY_API_KEY"
            exit 1
          fi
          KEY_PREFIX="${{ secrets.PERPLEXITY_API_KEY }}"
          echo "‚úÖ PERPLEXITY_API_KEY is set"
          echo "   Length: ${#KEY_PREFIX}"
          echo "   Prefix: ${KEY_PREFIX:0:5}"
          if [ "${KEY_PREFIX:0:5}" != "pplx-" ]; then
            echo "‚ö†Ô∏è  Warning: Key does not start with 'pplx-' (verify the value in GitHub Secrets)"
          fi
      
      - name: Check for existing drafts
        id: check_existing
        run: |
          set +e
          DRAFT_COUNT=$(find data/drafts/linkedin -name "*.txt" -type f 2>/dev/null | wc -l)
          echo "draft_count=$DRAFT_COUNT" >> $GITHUB_OUTPUT
          
          if [ "$DRAFT_COUNT" -gt 0 ]; then
            echo "‚úÖ Found $DRAFT_COUNT existing drafted post(s)"
          else
            echo "‚ö†Ô∏è  No existing drafted posts found"
          fi
      
      - name: Generate new content if needed
        if: github.event.inputs.skip_drafted == 'true' || steps.check_existing.outputs.draft_count == '0'
        env:
          PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}
        run: |
          if [ "${{ github.event.inputs.skip_drafted }}" == "true" ]; then
            echo "üîÑ Generating new LinkedIn content (skip_drafted=true)..."
          else
            echo "üîÑ Generating new LinkedIn content (no existing drafts found)..."
          fi
          
          SOURCE="${{ github.event.inputs.source || 'hackernews' }}"
          echo "  - Source: $SOURCE"
          python main.py fetch --source $SOURCE
          python main.py generate --count 1 --format linkedin
          echo "‚úÖ New content generated"
      
      - name: Check for content
        id: check_content
        run: |
          set +e
          DRAFT_COUNT=$(find data/drafts/linkedin -name "*.txt" -type f 2>/dev/null | wc -l)
          echo "draft_count=$DRAFT_COUNT" >> $GITHUB_OUTPUT
          
          if [ "$DRAFT_COUNT" -eq 0 ]; then
            echo "‚ùå No LinkedIn posts available to publish"
            echo "   Content generation may have failed - check logs above"
            exit 1
          fi
          
          # Get the first draft file for reference
          FIRST_DRAFT=$(find data/drafts/linkedin -name "*.txt" -type f | head -1)
          echo "first_draft=$FIRST_DRAFT" >> $GITHUB_OUTPUT
          echo "‚úÖ Found $DRAFT_COUNT drafted post(s) ready to publish"
      
      - name: Publish single post
        if: steps.check_content.outputs.draft_count > 0
        env:
          PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}
          LINKEDIN_ACCESS_TOKEN: ${{ secrets.LINKEDIN_ACCESS_TOKEN }}
          LINKEDIN_USER_ID: ${{ secrets.LINKEDIN_USER_ID }}
        run: |
          set +e
          
          echo "üì§ Publishing 1 LinkedIn post..."
          echo "  - Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          
          OUTPUT=$(python main.py publish --platform linkedin --approve --limit 1 2>&1)
          PUBLISH_EXIT_CODE=$?
          
          echo "$OUTPUT"
          
          if [ $PUBLISH_EXIT_CODE -eq 0 ]; then
            echo ""
            echo "‚úÖ Post published successfully!"
            echo ""
            echo "Published post details:"
            # Extract published URL from output if available
            PUBLISHED_URL=$(echo "$OUTPUT" | grep -oP 'https://www\.linkedin\.com[^\s]+' | head -1)
            if [ ! -z "$PUBLISHED_URL" ]; then
              echo "  üìé URL: $PUBLISHED_URL"
            fi
            exit 0
          else
            echo ""
            echo "‚ùå Failed to publish post"
            echo "Error details are shown above"
            exit 1
          fi
      
      - name: Publish result summary
        if: always()
        run: |
          echo "üìã One-Click Publish Summary:"
          echo "  - Workflow: Publish LinkedIn - Manual"
          echo "  - Posts published: $([[ '${{ job.status }}' == 'success' ]] && echo '1' || echo '0')"
          echo "  - Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "  - Status: ${{ job.status }}"
          echo ""
          echo "üí° Tip: Check the logs above for published post URL"
