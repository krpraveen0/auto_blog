name: Publish Medium - Scheduled

on:
  schedule:
    # Run weekly on Monday at 11 AM UTC
    - cron: '0 11 * * 1'
  
  workflow_dispatch:
    inputs:
      batch_size:
        description: 'Number of articles to publish (1-3)'
        required: true
        default: '1'
        type: choice
        options:
          - '1'
          - '2'
          - '3'
      publish_status:
        description: 'Medium publish status'
        required: false
        default: 'draft'
        type: choice
        options:
          - 'draft'
          - 'public'
          - 'unlisted'

jobs:
  generate_and_publish:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Initialize project
        run: |
          python main.py init
      
      - name: Validate environment
        run: |
          set +e
          if [ -z "${{ secrets.MEDIUM_INTEGRATION_TOKEN }}" ]; then
            echo "‚ùå Error: MEDIUM_INTEGRATION_TOKEN not configured"
            echo "Scheduled publishing will be skipped"
            exit 1
          fi
          if [ -z "${{ secrets.PERPLEXITY_API_KEY }}" ]; then
            echo "‚ùå Error: PERPLEXITY_API_KEY not configured"
            exit 1
          fi
          echo "‚úÖ Credentials validated"
      
      - name: Fetch latest research
        env:
          PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}
        run: |
          echo "üîç Fetching latest AI/ML research..."
          python main.py fetch --source all
          echo "‚úÖ Content fetched successfully"
      
      - name: Generate comprehensive Medium articles
        env:
          PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}
        run: |
          set +e
          
          BATCH_SIZE="${{ github.event.inputs.batch_size || '1' }}"
          
          echo "‚ú® Generating comprehensive Medium articles with diagrams..."
          echo "  - Count: $BATCH_SIZE"
          echo "  - Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          
          python main.py generate --count $BATCH_SIZE --format medium
          
          GENERATE_EXIT_CODE=$?
          
          if [ $GENERATE_EXIT_CODE -eq 0 ]; then
            echo ""
            echo "‚úÖ Content generation completed"
            DRAFT_COUNT=$(find data/drafts/medium -name "*.md" -type f 2>/dev/null | wc -l)
            echo "  - Medium articles: $DRAFT_COUNT"
          else
            echo ""
            echo "‚ö†Ô∏è Content generation encountered errors (will skip publishing)"
            exit 1
          fi
      
      - name: Check for content
        id: check_drafts
        run: |
          set +e
          DRAFT_COUNT=$(find data/drafts/medium -name "*.md" -type f 2>/dev/null | wc -l)
          echo "draft_count=$DRAFT_COUNT" >> $GITHUB_OUTPUT
          
          if [ "$DRAFT_COUNT" -eq 0 ]; then
            echo "‚ö†Ô∏è No Medium articles generated"
          else
            echo "‚úÖ Found $DRAFT_COUNT Medium article(s) ready to publish"
          fi
      
      - name: Publish to Medium
        if: steps.check_drafts.outputs.draft_count > 0
        env:
          PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}
          MEDIUM_INTEGRATION_TOKEN: ${{ secrets.MEDIUM_INTEGRATION_TOKEN }}
        run: |
          set +e
          
          BATCH_SIZE="${{ github.event.inputs.batch_size || '1' }}"
          STATUS="${{ github.event.inputs.publish_status || 'draft' }}"
          
          echo "üì∞ Publishing to Medium..."
          echo "  - Batch size: $BATCH_SIZE"
          echo "  - Status: $STATUS"
          echo "  - Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          
          python main.py publish --platform medium --approve --limit $BATCH_SIZE --medium-status $STATUS
          
          PUBLISH_EXIT_CODE=$?
          
          if [ $PUBLISH_EXIT_CODE -eq 0 ]; then
            echo ""
            echo "‚úÖ Medium publishing completed successfully"
            exit 0
          else
            echo ""
            echo "‚ö†Ô∏è Error during Medium publishing"
            echo "Articles not published - check logs for details"
            exit 1
          fi
      
      - name: Skip publishing - no drafts
        if: steps.check_drafts.outputs.draft_count == 0
        run: |
          echo "‚è≠Ô∏è Skipping Medium publishing"
          echo "No articles were generated (content may not meet quality threshold)"
      
      - name: Upload generated content
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: weekly-medium-content
          path: |
            data/drafts/medium/*.md
            data/published/medium/*.md
          retention-days: 90
          if-no-files-found: warn
      
      - name: Workflow Summary
        if: always()
        run: |
          echo "üìã Scheduled Medium Publishing Summary:"
          echo "  - Workflow: Publish Medium - Scheduled"
          echo "  - Schedule: Weekly (Monday 11 AM UTC)"
          echo "  - Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "  - Status: ${{ job.status }}"
          echo ""
          echo "üí° About this workflow:"
          echo "  - Automatically fetches latest AI/ML research"
          echo "  - Generates comprehensive analysis with diagrams"
          echo "  - Publishes to Medium as 'draft' by default"
          echo "  - Articles include Mermaid diagrams and detailed explanations"
          echo ""
          echo "üìù Content features:"
          echo "  - Complete paper breakdown (2000+ words)"
          echo "  - Architecture diagrams"
          echo "  - Process flow visualizations"
          echo "  - Methodology deep-dive"
          echo "  - Results analysis"
          echo "  - Real-world applications"
