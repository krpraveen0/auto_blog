name: Publish Medium - Manual (On-Demand)

on:
  workflow_dispatch:
    inputs:
      topic:
        description: 'Topic to generate and publish (e.g., "LLM agents", "Diffusion models")'
        required: false
        type: string
      use_existing:
        description: 'Use existing drafts instead of generating new content'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      publish_status:
        description: 'Medium publish status'
        required: false
        default: 'draft'
        type: choice
        options:
          - 'draft'
          - 'public'
          - 'unlisted'
      count:
        description: 'Number of articles to publish'
        required: false
        default: '1'
        type: choice
        options:
          - '1'
          - '2'
          - '3'

jobs:
  publish_medium:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Initialize project
        run: |
          python main.py init
      
      - name: Validate environment
        run: |
          set +e
          if [ -z "${{ secrets.MEDIUM_INTEGRATION_TOKEN }}" ]; then
            echo "‚ùå Error: MEDIUM_INTEGRATION_TOKEN not configured"
            echo "Setup instructions:"
            echo "1. Go to: https://medium.com/me/settings"
            echo "2. Scroll to 'Integration tokens' section"
            echo "3. Create a new token"
            echo "4. Add to: Settings > Secrets and variables > Actions > MEDIUM_INTEGRATION_TOKEN"
            exit 1
          fi
          if [ -z "${{ secrets.PERPLEXITY_API_KEY }}" ]; then
            echo "‚ùå Error: PERPLEXITY_API_KEY not configured"
            exit 1
          fi
          echo "‚úÖ Credentials validated"
      
      - name: Generate new content
        if: github.event.inputs.use_existing == 'false'
        env:
          PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}
        run: |
          set +e
          
          TOPIC="${{ github.event.inputs.topic }}"
          COUNT="${{ github.event.inputs.count || '1' }}"
          
          echo "üìù Generating comprehensive Medium content..."
          if [ ! -z "$TOPIC" ]; then
            echo "  - Topic: $TOPIC"
          fi
          echo "  - Count: $COUNT"
          echo "  - Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          
          # Fetch latest content
          python main.py fetch --source all
          
          # Generate comprehensive Medium articles with diagrams
          python main.py generate --count $COUNT --format medium
          
          GENERATE_EXIT_CODE=$?
          
          if [ $GENERATE_EXIT_CODE -eq 0 ]; then
            echo ""
            echo "‚úÖ Content generation completed"
            DRAFT_COUNT=$(find data/drafts/medium -name "*.md" -type f 2>/dev/null | wc -l)
            echo "  - Medium articles: $DRAFT_COUNT"
          else
            echo ""
            echo "‚ö†Ô∏è Content generation encountered errors"
            exit 1
          fi
      
      - name: Check for content
        id: check_content
        run: |
          set +e
          DRAFT_COUNT=$(find data/drafts/medium -name "*.md" -type f 2>/dev/null | wc -l)
          echo "draft_count=$DRAFT_COUNT" >> $GITHUB_OUTPUT
          
          if [ "$DRAFT_COUNT" -eq 0 ]; then
            echo "‚ùå No Medium articles available to publish"
            echo "   Either generate content first or check if drafts exist"
            exit 1
          fi
          
          echo "‚úÖ Found $DRAFT_COUNT Medium article(s)"
      
      - name: Publish to Medium
        if: steps.check_content.outputs.draft_count > 0
        env:
          PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}
          MEDIUM_INTEGRATION_TOKEN: ${{ secrets.MEDIUM_INTEGRATION_TOKEN }}
        run: |
          set +e
          
          LIMIT="${{ github.event.inputs.count || '1' }}"
          STATUS="${{ github.event.inputs.publish_status || 'draft' }}"
          
          echo "üì∞ Publishing to Medium..."
          echo "  - Count: $LIMIT"
          echo "  - Status: $STATUS"
          echo "  - Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          
          OUTPUT=$(python main.py publish --platform medium --approve --limit $LIMIT --medium-status $STATUS 2>&1)
          PUBLISH_EXIT_CODE=$?
          
          echo "$OUTPUT"
          
          if [ $PUBLISH_EXIT_CODE -eq 0 ]; then
            echo ""
            echo "‚úÖ Articles published successfully to Medium!"
            echo ""
            # Extract published URLs from output if available
            echo "Published article details are shown above"
            exit 0
          else
            echo ""
            echo "‚ùå Failed to publish articles"
            echo "Error details are shown above"
            exit 1
          fi
      
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: medium-content
          path: |
            data/drafts/medium/*.md
            data/published/medium/*.md
          retention-days: 30
          if-no-files-found: warn
      
      - name: Publish result summary
        if: always()
        run: |
          echo "üìã Medium Publishing Summary:"
          echo "  - Workflow: Publish Medium - Manual"
          echo "  - Topic: '${{ github.event.inputs.topic }}'"
          echo "  - Use existing: ${{ github.event.inputs.use_existing }}"
          echo "  - Publish status: ${{ github.event.inputs.publish_status }}"
          echo "  - Count requested: ${{ github.event.inputs.count }}"
          echo "  - Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "  - Status: ${{ job.status }}"
          echo ""
          echo "üí° Tips:"
          echo "  - Check artifacts for generated content"
          echo "  - 'draft' status allows you to review before publishing"
          echo "  - Articles include comprehensive analysis and diagrams"
